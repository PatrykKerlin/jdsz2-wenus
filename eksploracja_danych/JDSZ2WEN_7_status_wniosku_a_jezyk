/* Eksploracja Danych - status wniosku ze wzgledu na jezyk
i stan wniosku */

---- dla wszystkich ---------------
SELECT COUNT(1) as ilosc_wnioskow, w.stan_wniosku as stan_wniosku_dla_wszystkich_jezykow
FROM wnioski w
WHERE w.stan_wniosku like 'wyp%' or w.stan_wniosku like 'odrz%'
GROUP BY w.stan_wniosku
ORDER by COUNT(1) DESC

---- dla 10 bez en ----------------
SELECT COUNT(1) as ilosc_wnioskow, w.stan_wniosku as stan_wnioskow_dla_10, lower(w.jezyk) as jezyk
from wnioski w
Where w.jezyk in ('pl', 'da', 'sv', 'pt', 'de', 'nb', 'fi', 'it', 'es')
and (w.stan_wniosku like 'wyp%' or w.stan_wniosku like 'odrz%')
GROUP BY w.jezyk, w.stan_wniosku
ORDER BY w.jezyk, COUNT (1) DESC

---- dla en---------------
SELECT COUNT (1) as ilosc_wnioskow, w.stan_wniosku as stan_wniosku_dla_en
FROM wnioski w
WHERE lower(jezyk) = 'en' and
w.stan_wniosku like 'wyp%' or w.stan_wniosku like 'odrz%'
GROUP BY w.stan_wniosku
ORDER by COUNT (1) DESC



---/*-wyliczenie wszystkich odrzuconych i wyplaconych dla en oraz 10 jezykow jako inne_jezyki
grupowanie po stanie wniosku oraz roku
wniski z roku 2018 zostały odfiltrowane
wszystkie wnioski ze stanem rozpoczynającym się od 'odrzucone' zostały zgrupowane w jedno

*/
With tab1 as (
              SELECT
              Count(Case when jezyk like 'en' then 1 end) as angielski,
              Count(Case When jezyk in ('pl', 'da', 'sv', 'pt', 'de', 'nb', 'fi', 'it', 'es') then 1 end) as inne_jezyki,
              Count(*) as wszystkie,
              round(Sum(kwota_rekompensaty),2) as suma_rekompensat,
              LEFT(stan_wniosku,9) as stan,
              date_part('year',data_utworzenia) as rok
              from wnioski
              where (stan_wniosku like 'wyp%' or stan_wniosku like 'odrz%') and date_part('year',data_utworzenia) not in ('2018')
              GROUP by LEFT(stan_wniosku,9), rok

)
SELECT *
 from tab1
